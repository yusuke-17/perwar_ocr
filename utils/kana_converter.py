"""
歴史的仮名遣い → 現代仮名遣い 変換モジュール

戦前文書で使われている歴史的仮名遣い（旧仮名遣い）を
現代仮名遣いに変換する。

注意:
  - 文脈によって変換が異なるケースがあるため、100%正確ではない
  - 長い文字列から先にマッチさせることで誤変換を減らしている
"""

# ---------- 歴史的仮名遣い → 現代仮名遣い 変換辞書 ----------
# 戦前公文書で頻出するパターンを収録
# 長い文字列を先に定義し、短い文字列での誤マッチを防ぐ

# ワ行 → ア行 の変換（助詞以外）
# 「は」「へ」「を」は助詞として使う場合があるため自動変換しない
KANA_MAPPINGS: list[tuple[str, str]] = [
    # ゐ・ゑ の変換
    ("ゐ", "い"),
    ("ゑ", "え"),
    ("ヰ", "イ"),
    ("ヱ", "エ"),
    # 注意: 「ヲ」→「オ」は行わない
    # 戦前公文書の「ヲ」はほぼ助詞（を）として使われており、
    # 一律「オ」に変換すると「命令ヲ受ケタ→命令オ受ケタ」のように壊れる。
    # 助詞の処理はLLMリライトに委譲する。

    # 合拗音（くゎ/ぐゎ → か/が）
    ("クヮ", "カ"),
    ("グヮ", "ガ"),
    ("くゎ", "か"),
    ("ぐゎ", "が"),

    # てふ → ちょう（蝶 = てふてふ → ちょうちょう）
    ("テフ", "チョー"),
    ("てふ", "ちょう"),

    # 長音の歴史的仮名遣い（カタカナ）
    # 戦前文書ではカタカナ表記が多い
    ("アウ", "オー"),
    ("カウ", "コー"),
    ("サウ", "ソー"),
    ("タウ", "トー"),
    ("ナウ", "ノー"),
    ("ハウ", "ホー"),
    ("マウ", "モー"),
    ("ヤウ", "ヨー"),
    ("ラウ", "ロー"),
    ("ワウ", "オー"),
    ("ガウ", "ゴー"),
    ("ザウ", "ゾー"),
    ("ダウ", "ドー"),
    ("バウ", "ボー"),
    ("パウ", "ポー"),

    # エウ → ヨー
    ("エウ", "ヨー"),
    ("ケウ", "キョー"),
    ("セウ", "ショー"),
    ("テウ", "チョー"),
    ("ネウ", "ニョー"),
    ("ヘウ", "ヒョー"),
    ("メウ", "ミョー"),
    ("レウ", "リョー"),
    ("ゲウ", "ギョー"),
    ("ゼウ", "ジョー"),
    ("デウ", "ヂョー"),
    ("ベウ", "ビョー"),
    ("ペウ", "ピョー"),

    # イウ → ユー
    ("イウ", "ユー"),
    ("キウ", "キュー"),
    ("シウ", "シュー"),
    ("チウ", "チュー"),
    ("ニウ", "ニュー"),
    ("ヒウ", "ヒュー"),
    ("ミウ", "ミュー"),
    ("リウ", "リュー"),
    ("ギウ", "ギュー"),
    ("ジウ", "ジュー"),
    ("ヂウ", "ヂュー"),
    ("ビウ", "ビュー"),
    ("ピウ", "ピュー"),

    # 注意: 四つ仮名（ヂ/ヅ → ジ/ズ）の一律変換は行わない
    # 連濁（はなぢ＝鼻血）や同音連呼（つづく＝続く）では
    # 現代仮名遣いでもぢ/づを保持すべき。
    # 文脈依存のためLLMリライトに委譲する。

    # ひらがなの長音パターン（頻出するもの）
    ("あう", "おう"),
    ("かう", "こう"),
    ("さう", "そう"),
    ("たう", "とう"),
    ("はう", "ほう"),
    ("まう", "もう"),
    ("やう", "よう"),
    ("らう", "ろう"),
    ("がう", "ごう"),
    ("ざう", "ぞう"),
    ("だう", "どう"),
    ("ばう", "ぼう"),
    ("ぱう", "ぽう"),

    ("えう", "よう"),
    ("けう", "きょう"),
    ("せう", "しょう"),
    ("てう", "ちょう"),
    ("へう", "ひょう"),
    ("げう", "ぎょう"),
    ("ぜう", "じょう"),
    ("べう", "びょう"),
    ("ぺう", "ぴょう"),
]


def convert_historical_kana(text: str) -> str:
    """
    テキスト中の歴史的仮名遣いを現代仮名遣いに変換する

    注意: 文脈依存の変換（「は」→「わ」等）は行わない。
    助詞の「は」「へ」「を」を誤変換するリスクがあるため。

    Args:
        text: 変換対象のテキスト

    Returns:
        現代仮名遣いに変換されたテキスト
    """
    for old, new in KANA_MAPPINGS:
        text = text.replace(old, new)
    return text


def find_historical_kana(text: str) -> list[tuple[str, str, int]]:
    """
    テキスト中に含まれる歴史的仮名遣いを検出する

    Args:
        text: 検査対象のテキスト

    Returns:
        (旧仮名, 現代仮名, 出現位置) のリスト
    """
    found = []
    for old, new in KANA_MAPPINGS:
        start = 0
        while True:
            pos = text.find(old, start)
            if pos == -1:
                break
            found.append((old, new, pos))
            start = pos + len(old)
    # 位置順にソート
    found.sort(key=lambda x: x[2])
    return found
